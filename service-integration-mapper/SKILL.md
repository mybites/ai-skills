---
name: service-integration-mapper
description: Transform DEV_OVERVIEW.md into a structured YAML integration map for cross-service flow analysis
triggers:
  - "map service integrations"
  - "create integration map"
  - "generate service yaml"
  - "extract service connections"
---

# Service Integration Mapper

Transform a `DEV_OVERVIEW.md` file into a structured YAML file that explicitly maps all service inputs, outputs, and data ownership. Designed to enable automated cross-service flow analysis.

## Goal

Produce a single file:
- **`{service-name}.yaml`** - Structured integration map with consumes/produces/data sections

## Input

- `DEV_OVERVIEW.md` (or `{service}_DEV_OVERVIEW.md`) - Generated by dev-overview-generator skill

## Output Location

```
docs/tech/flows/technical/{service-name}.yaml
```

## Output Philosophy

- **Explicit over implicit**: Every HTTP call needs verb + path
- **Traceable**: Queue messages include message_type and payload schema
- **Connectable**: Structure enables matching `produces` ↔ `consumes` across services
- **Complete**: Capture all inputs, outputs, and side effects

---

## Output Schema

```yaml
# Service Integration Map: {service-name}
# Auto-generated: {date}
#
# Documents all inputs, outputs, and data ownership for this service.

service: {service-name}
tech: {language/framework}
role: {1-line description}

# ============================================================
# CONSUMES (Inputs)
# ============================================================

consumes:

  http:
    - verb: GET | POST | PUT | PATCH | DELETE
      path: /api/endpoint/:param
      source: {who calls this - client | service-name | external-system}
      auth: {optional - Bearer token | API key | etc}
      purpose: {what it does}

  queues:
    - queue: {QUEUE_NAME_ENV_VAR}
      message_type: {MessageTypeName}
      source: {publishing service}
      handler: {handlerFunctionName}
      purpose: {what it does}
      payload:
        field1: type
        field2: type

  webhooks:
    - verb: POST
      path: /webhook/path
      source: {external service - Twilio | SendGrid | Stripe | etc}
      message_type: {WebhookTypeName}
      purpose: {what it does}
      payload:
        field1: type
        field2: type

# ============================================================
# PRODUCES (Outputs)
# ============================================================

produces:

  http_calls:
    - verb: GET | POST | PUT | PATCH | DELETE
      target: {service-name}
      path: /api/endpoint
      purpose: {why it calls this}

  http_proxy:  # Only for gateway services
    - verb: "*" | GET | POST
      path: /api/pattern/*
      target: {downstream-service}
      purpose: {what it proxies}

  queues:
    - queue: {QUEUE_NAME_ENV_VAR}
      message_type: {MessageTypeName}
      trigger: {what causes this to publish}
      purpose: {what consumers should do with it}
      payload:
        field1: type
        field2: type

  external_calls:
    - service: {Twilio | SendGrid | AWS S3 | OpenAI | etc}
      action: {what it does - Send SMS | Upload file | etc}
      trigger: {what causes this call}
      credentials: {optional - where creds come from}

  database_writes:
    - table: {table_name}
      operations: [insert, update, delete]
      trigger: {what causes this write}

  cache_writes:
    - cache: Redis | Memcached
      key_pattern: "prefix:{variable}:*"
      purpose: {what it caches}
      trigger: {what causes this write}
      ttl: {optional - duration}

  analytics:
    - destination: {BigQuery | Segment | Mixpanel | etc}
      event_type: {event_name}
      trigger: {what causes this event}

# ============================================================
# DATA OWNERSHIP
# ============================================================

data:

  owns:
    postgresql:
      - {table_name}
    mongodb:
      - {collection_name}
    redis:
      - "{key_pattern}"

  reads_from:
    postgresql:
      - {table_name} (from {service-name})

  shared_with:
    postgresql:
      - {table_name} (shared with {service-name})
```

---

## Extraction Rules

### From DEV_OVERVIEW.md sections:

| DEV_OVERVIEW Section | Maps To |
|---------------------|---------|
| **Exposes > APIs** | `consumes.http` (these are endpoints the service handles) |
| **Exposes > Events Published** | `produces.queues` |
| **Consumes > Services** | `produces.http_calls` (services this one calls) |
| **Consumes > Events Subscribed** | `consumes.queues` |
| **Proxied Routes** (gateway only) | `produces.http_proxy` |
| **Data Ownership > Primary Storage** | `data.owns` |
| **External Dependencies** | `produces.external_calls` |

### HTTP Verb Inference

If DEV_OVERVIEW only shows path without verb, infer from pattern:

| Pattern | Likely Verb |
|---------|-------------|
| `GET /resource/` | GET (list) |
| `GET /resource/:id` | GET (single) |
| `POST /resource/` | POST (create) |
| `PUT /resource/:id` | PUT (replace) |
| `PATCH /resource/:id` | PATCH (update) |
| `DELETE /resource/:id` | DELETE |
| `POST /resource/:id/action` | POST (action) |

### Source Inference

| Clue | Source Value |
|------|--------------|
| Route proxied from gateway | `api-gateway (proxy)` |
| SCIM/SSO endpoint | `Identity Provider (Okta, Azure AD, etc.)` |
| Webhook from known service | `{ServiceName}` (e.g., Stripe, Twilio) |
| General API | `clients` or specific service name |
| Internal/cron trigger | `internal/cron` |

### Queue Naming

- Use the environment variable name: `ORDER_CREATED_QUEUE_URL`
- Include message_type as PascalCase: `OrderCreatedEvent`
- Payload should list key fields with types

### Unknown/Inferred Items

- Mark uncertain items with `note: "[INFERRED]"`
- If a service is called but not documented, use: `target: "[UNKNOWN] service-name"`

---

## Execution Instructions

### Step 1: Locate DEV_OVERVIEW

```bash
# Find the DEV_OVERVIEW file
find . -name "*DEV_OVERVIEW.md" | head -5
```

### Step 2: Extract Service Identity

From the header and Tech Stack section:
- `service`: From title or filename
- `tech`: From Tech Stack
- `role`: From Responsibility section (first sentence)

### Step 3: Process "Exposes" Section

**APIs → consumes.http**
```
| `POST /api/accounts/login/` | User authentication |
```
Becomes:
```yaml
- verb: POST
  path: /api/accounts/login/
  source: clients
  purpose: User authentication
```

**Events Published → produces.queues**
```
| `order_created` | ORDER_CREATED_QUEUE_URL | When order is placed |
```
Becomes:
```yaml
- queue: ORDER_CREATED_QUEUE_URL
  message_type: OrderCreatedEvent
  trigger: When order is placed
  payload:
    orderId: number
    customerId: number
    action: string
```

### Step 4: Process "Consumes" Section

**Services → produces.http_calls**
```
| `inventory-service` | Stock availability, reservation |
```
Becomes:
```yaml
- verb: POST
  target: inventory-service
  path: /api/inventory/:productId/check
  purpose: Stock availability, reservation
```

Note: You may need to look at the target service's DEV_OVERVIEW to get exact paths.

**Events Subscribed → consumes.queues**
```
| Order Created | `CONSUMER_QUEUE_FULFILLMENT_ORDER_URL` | Initiate fulfillment |
```
Becomes:
```yaml
- queue: CONSUMER_QUEUE_FULFILLMENT_ORDER_URL
  message_type: OrderCreatedEvent
  source: order-service
  handler: fulfillmentOrderConsumer
  purpose: Initiate fulfillment workflow
```

### Step 5: Process "Proxied Routes" (Gateway Only)

```
| `/api/orders/*` | ORDER_SERVICE_URL | Order operations |
```
Becomes:
```yaml
http_proxy:
  - verb: "*"
    path: /api/orders/*
    target: order-service
    purpose: Order operations
```

### Step 6: Process "Data Ownership"

**Primary Storage → data.owns**
```
| `orders` | Customer orders |
```
Becomes:
```yaml
owns:
  postgresql:
    - orders
```

### Step 7: Process "External Dependencies"

```
| Stripe | Payment processing |
```
Becomes:
```yaml
external_calls:
  - service: Stripe
    action: Payment processing
    trigger: Order checkout
```

### Step 8: Create Output Directory and File

```bash
mkdir -p docs/tech/flows/technical
```

Save as: `docs/tech/flows/technical/{service-name}.yaml`

---

## Quality Checklist

Before finalizing, verify:

- [ ] Every HTTP endpoint has verb + path
- [ ] Every queue has queue name + message_type + payload
- [ ] Every external call has service + action + trigger
- [ ] Every database table is in either `owns` or `reads_from`
- [ ] Gateway services have `http_proxy` section
- [ ] Unknown services marked with `[UNKNOWN]`
- [ ] Inferred items marked with `[INFERRED]`
- [ ] Payload schemas include key fields with types

---

## Example Transformation

**Input (DEV_OVERVIEW.md excerpt):**
```markdown
## Exposes

### APIs
| Endpoint | Purpose |
|----------|---------|
| `POST /api/v2/orders/:customer_id/checkout` | Create order |
| `GET /api/orders/:customer_id/history` | Get order history |

### SQS Queues Consumed
| Queue | Handler | Purpose |
|-------|---------|---------|
| `PAYMENT_RESULT_QUEUE_URL` | `handlePaymentResult` | Process payment outcome |

## Consumes

### Services
| Service | Purpose |
|---------|---------|
| `inventory-service` | Stock reservation |

## External Dependencies
| Service | Purpose |
|---------|---------|
| Stripe | Payment processing |
| Google BigQuery | Analytics |
```

**Output ({service}.yaml excerpt):**
```yaml
consumes:
  http:
    - verb: POST
      path: /api/v2/orders/:customer_id/checkout
      source: api-gateway (proxy)
      purpose: Create order

    - verb: GET
      path: /api/orders/:customer_id/history
      source: api-gateway (proxy)
      purpose: Get order history

  queues:
    - queue: PAYMENT_RESULT_QUEUE_URL
      message_type: PaymentResultEvent
      source: payment-service
      handler: handlePaymentResult
      purpose: Process payment outcome
      payload:
        orderId: number
        customerId: number
        status: string
        amount: number

produces:
  http_calls:
    - verb: POST
      target: inventory-service
      path: /api/inventory/:productId/reserve
      purpose: Stock reservation
      note: "[INFERRED] exact endpoint"

  external_calls:
    - service: Stripe
      action: Charge payment
      trigger: PAYMENT_RESULT_QUEUE_URL consumed

    - service: Google BigQuery
      action: Log analytics event
      trigger: Order completed/failed
```

---

## Notes

- Run this skill after dev-overview-generator
- Output is designed to be consumed by connections-builder skill
- For services not yet documented, create placeholder with `[UNKNOWN]` markers
- Generated files should be committed to the repository for version tracking
