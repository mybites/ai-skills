---
name: ddd-flow-mapper
description: Transform technical connections into business-language flows using domain-driven design terminology
triggers:
  - "create business flows"
  - "map ddd flows"
  - "generate domain flows"
  - "translate to business language"
---

# DDD Flow Mapper

Transform technical integration flows from `_connections.yaml` into business-language documentation using domain-driven design (DDD) terminology.

## Goal

Produce business-friendly flow documentation:
- **`flows/_index.yaml`** - Domain index with glossary
- **`flows/{domain}/{flow-name}.yaml`** - Individual flow files in business language

## Input

- `docs/tech/flows/technical/_connections.yaml` - Generated by connections-builder
- `glossary.yaml` (optional) - Business term definitions

## Output Location

```
docs/tech/flows/
├── _index.yaml
├── shopping/
│   ├── browse-catalog.yaml
│   └── add-to-cart.yaml
├── checkout/
│   ├── place-order.yaml
│   └── apply-discount.yaml
├── fulfillment/
│   ├── ship-order.yaml
│   └── delivery-confirmation.yaml
└── ...
```

---

## Domain Categories

Organize flows by business domain, not technical service:

| Domain | Business Meaning | Example Flows |
|--------|------------------|---------------|
| `onboarding` | Getting users into the platform | sign-up, verify-email, complete-profile |
| `identity` | Managing who users are | sync-from-hr-system, provision-via-scim, merge-accounts |
| `shopping` | Product discovery and selection | browse-catalog, search-products, add-to-cart |
| `checkout` | Converting cart to order | place-order, apply-discount, select-shipping |
| `fulfillment` | Getting orders to customers | ship-order, track-delivery, handle-return |
| `engagement` | Tracking & communication | send-notification, track-activity, generate-report |

---

## _index.yaml Schema

```yaml
# Business Flows Index
# Auto-generated: {date}

domains:

  onboarding:
    description: Getting users into the platform and ready to go
    flows:
      - sign-up
      - verify-email
      - complete-profile

  checkout:
    description: Converting shopping carts into confirmed orders
    flows:
      - place-order
      - apply-discount
      - select-shipping

  fulfillment:
    description: Getting confirmed orders to customers
    flows:
      - ship-order
      - track-delivery
      - handle-return

  # ... more domains

glossary:
  order: A confirmed purchase containing one or more items
  cart: Temporary collection of items before checkout
  SKU: Stock Keeping Unit — unique identifier for a product variant
  fulfillment: The process of picking, packing, and shipping an order
  campaign: Scheduled promotion or notification targeting a user segment
  organization: A company/tenant with its own users and settings
  attribute: Custom field for user segmentation (department, role)
  hr_system: External source of user data (Okta, Azure AD, SAP)
  scim: Standard protocol for automated user provisioning
```

---

## Flow File Schema

```yaml
# Flow: {Human-readable Name}
#
# Business Context:
#   {2-3 sentences explaining why this flow exists}
#
# Business Value:
#   - {Value point 1}
#   - {Value point 2}

id: {flow-id-kebab-case}
name: {Human Readable Name}
domain: {domain-name}

description: |
  {Paragraph describing what this flow accomplishes
  from a business perspective. No technical jargon.}

trigger:
  type: user_action | scheduled | external | internal
  actor: {who initiates - User | Admin | HR System | etc}
  action: {what they do in business terms}

actors:
  - {Actor 1}
  - {Actor 2}

preconditions:
  - {Business condition 1}
  - {Business condition 2}

# ----- FLOW STEPS (Business Language) -----

steps:
  - seq: 1
    action: {What happens in business terms}
    actor: {Who does it}
    details: |
      {Optional elaboration in plain language}
    outcome: {What results from this step}

  - seq: 2
    action: {Next business action}
    # ... etc

# ----- OUTCOMES -----

outcomes:
  success:
    - {Business outcome 1}
    - {Business outcome 2}

  failure_modes:
    - {What can go wrong} → {What happens}

# ----- RELATED FLOWS -----

related_flows:
  - {flow-id}: {relationship - "prerequisite" | "alternative" | "follow-up"}

# ----- TECHNICAL REFERENCE (collapsed/hidden) -----

_technical:
  source: _connections.yaml#{e2e_flow_id}
  repos_involved:
    - {service-name}
  queues:
    - {queue-name}
  endpoints:
    - {verb} {path}
```

---

## Translation Rules

### Technical → Business Language

| Technical | Business |
|-----------|----------|
| POST /api/orders/checkout | Customer places order |
| Publish to ORDER_CREATED_QUEUE_URL | Queue order for processing |
| handleOrderCreated consumes queue | System processes new order |
| Stripe API call | Process payment |
| INSERT INTO orders | Create order record |
| Redis cache write | Remember for later |
| BigQuery log | Track for analytics |

### Service Names → Actor Names

| Service | Actor |
|---------|-------|
| api-gateway | Platform |
| inventory-service | Warehouse System |
| payment-service | Payment System |
| notification-service | Notification System |
| Stripe | Payment Provider |
| SendGrid | Email Provider |
| Okta/Azure AD | Identity Provider |

### Queue Names → Business Events

| Queue | Business Event |
|-------|----------------|
| ORDER_CREATED_QUEUE_URL | New order placed |
| PAYMENT_RESULT_QUEUE_URL | Payment processed |
| SHIPMENT_CREATED_QUEUE_URL | Shipment dispatched |
| LOW_STOCK_ALERT_QUEUE_URL | Stock running low |

---

## Execution Instructions

### Step 1: Read _connections.yaml

Load the `e2e_flows` section.

### Step 2: Categorize Each Flow

For each e2e_flow:
1. Read the `name` and `description`
2. Identify the business domain based on:
   - Key entities involved (order, product, shipment)
   - Primary action (create, ship, track)
   - Who benefits (customer, admin, manager)
3. Assign to appropriate domain folder

### Step 3: Transform Each Flow

For each e2e_flow, create a business flow:

1. **Translate name**
   - "Order Checkout with Payment" → "Place Order"
   - "Provision User via HR Sync" → "Sync from HR System"

2. **Write business description**
   - Focus on what and why, not how
   - Use glossary terms
   - Avoid service names

3. **Identify actors**
   - Map services to business actors
   - Include human actors (Customer, Admin, Manager)

4. **Transform steps**
   - Replace API calls with business actions
   - Replace queue operations with "system processes"
   - Replace external calls with provider names
   - Hide technical details in `_technical` section

5. **Define outcomes**
   - What does success look like?
   - What can go wrong?

### Step 4: Build Glossary

Collect all domain terms used across flows:
1. Extract from DEV_OVERVIEW "Key Domain Concepts"
2. Add terms that appear in flow descriptions
3. Define in plain language

### Step 5: Create _index.yaml

1. Group flows by domain
2. Add domain descriptions
3. Include glossary

### Step 6: Write Files

Create directory structure and save all files.

---

## Example Transformation

**Input (_connections.yaml):**
```yaml
e2e_flows:
  - name: Order Checkout with Payment
    description: Customer checks out cart, payment is processed
    steps:
      - seq: 1
        type: http
        source: storefront (client)
        target: api-gateway
        path: POST /api/v2/orders/:customer_id/checkout

      - seq: 2
        type: http
        source: order-service
        target: inventory-service
        path: POST /api/inventory/:productId/reserve

      - seq: 3
        type: external
        source: payment-service
        target: Stripe
        action: Create charge

      - seq: 4
        type: queue
        publisher: payment-service
        queue: PAYMENT_RESULT_QUEUE_URL
        consumer: order-service
```

**Output (checkout/place-order.yaml):**
```yaml
# Flow: Place Order
#
# Business Context:
#   Customers need a seamless way to convert their shopping cart into a
#   confirmed order. This flow handles stock verification, payment, and
#   order confirmation in one smooth process.
#
# Business Value:
#   - Customers can purchase with confidence (stock is verified)
#   - Payment is secure and immediate
#   - Order confirmation is instant

id: place-order
name: Place Order
domain: checkout

description: |
  Convert a customer's shopping cart into a confirmed, paid order.
  The system verifies stock availability, processes payment through
  a secure provider, and confirms the order.

trigger:
  type: user_action
  actor: Customer
  action: Clicks "Place Order" on checkout page

actors:
  - Customer
  - Warehouse System
  - Payment System
  - Payment Provider

preconditions:
  - Cart has at least one item
  - Customer has a valid payment method
  - Customer has confirmed shipping address

steps:
  - seq: 1
    action: Customer submits order
    actor: Customer
    details: |
      Customer reviews their cart, confirms shipping details,
      and clicks the checkout button.
    outcome: Order request submitted

  - seq: 2
    action: System verifies stock availability
    actor: Warehouse System
    details: |
      Checks that all items in the cart are in stock
      and reserves them to prevent overselling.
    outcome: Stock reserved for this order

  - seq: 3
    action: Payment is processed
    actor: Payment Provider
    details: |
      Charges the customer's payment method for the
      order total including tax and shipping.
    outcome: Payment confirmed or declined

  - seq: 4
    action: Order is confirmed
    actor: Platform
    details: |
      Order record is created and customer receives
      confirmation with order number and estimated delivery.
    outcome: Customer sees order confirmation

outcomes:
  success:
    - Order created with unique order number
    - Payment successfully charged
    - Customer receives confirmation email
    - Stock reserved for fulfillment

  failure_modes:
    - Item out of stock → Customer notified, item removed from cart
    - Payment declined → Customer prompted to try another method
    - System error → Order saved as draft, customer can retry

related_flows:
  - ship-order: "Follow-up: fulfillment begins"
  - track-delivery: "Customer tracks their order"
  - handle-return: "Customer returns items"

_technical:
  source: _connections.yaml#order-checkout-with-payment
  repos_involved:
    - api-gateway
    - order-service
    - inventory-service
    - payment-service
  queues:
    - PAYMENT_RESULT_QUEUE_URL
  endpoints:
    - POST /api/v2/orders/:customer_id/checkout
    - POST /api/inventory/:productId/reserve
```

---

## Quality Checklist

- [ ] No technical jargon in steps (no API paths, queue names)
- [ ] Actors are business roles, not service names
- [ ] Description explains business value
- [ ] Glossary terms used consistently
- [ ] Related flows linked
- [ ] Technical details hidden in `_technical` section
- [ ] A non-developer can understand the flow
- [ ] Domain categorization makes sense

---

## Notes

- This skill bridges technical documentation and business understanding
- Flows should be readable by Product, CS, and Sales teams
- The `_technical` section preserves traceability without cluttering
- Update flows when business processes change
- Glossary should evolve with the domain language
